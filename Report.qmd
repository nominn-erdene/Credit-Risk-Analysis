---
title: "Зээлийн эрсдэлийг статистик загварчлалаар үнэлэх"
subtitle: ""
abstract: German Credit dataset дээр borrower-level мэдээлэл ашиглан зээлийн чанарыг (good/bad) логистик регрессээр үнэлж, эрсдэлийн ангилал, AUC ба үндсэн драйверуудыг тооцоов.
author: ""
date: 2025-11-20
date-format: "YYYY оны M-р сарын D"
project:
  execute-dir: project
  preview: false
toc: true
toc-depth: 3
toc-title: Агуулга
number-sections: true
format:
  pdf:
    echo: true
    pdf-engine: pdflatex
    papersize: a4paper
    geometry:
      - left=2cm
      - right=2cm
      - top=2cm
      - bottom=3cm
    include-in-header:
      - text: |
          \usepackage[english,mongolian]{babel}
          \usepackage[T1]{fontenc}
          \usepackage[utf8]{inputenc}
          \usepackage{lmodern}             % serif/sans/mono пакетаар шрифтийг бүрдүүлэх
          \usepackage{inconsolata}         % моно фонтыг pdftex-д тааруулсан
          \usepackage{amsmath,amssymb}     % суурь математик орчин
          \AddToHook{env/Highlighting/begin}{\footnotesize}
          % үндсэн гарчиг
          \usepackage{titling}
          \pretitle{\begin{center}\LARGE\bfseries}
          \posttitle{\par\end{center}\vskip 1em}
          % сэдвийн зүйлчлэл хэсгийн шрифт
          \usepackage{titlesec}
          \titleformat{\section}{\normalfont\Large\bfseries\selectfont}{\thesection}{1em}{}
          \titleformat{\subsection}{\normalfont\large\bfseries\selectfont}{\thesubsection}{1em}{}
          \titleformat{\subsubsection}{\normalfont\normalsize\bfseries\selectfont}{\thesubsubsection}{1em}{}
          % сэдвийн жагсаалт доторх шрифт
          \usepackage{tocloft}
          \renewcommand{\cfttoctitlefont}{\Large\bfseries}
          \renewcommand{\cftaftertoctitle}{\vskip 1em}
          \renewcommand{\cftsecfont}{\normalfont\selectfont}
          \renewcommand{\cftsecpagefont}{\normalfont\selectfont}
          \renewcommand{\cftsubsecfont}{\normalfont\selectfont}
          \renewcommand{\cftsubsecpagefont}{\normalfont\selectfont}
          \renewcommand{\contentsname}{Агуулга}
    latex-max-runs: 3
editor: source
execute:
  echo: false
  warning: false
crossref: 
  fig-title: Зураг
  fig-prefix: Зураг
  tbl-title: Хүснэгт
  tbl-prefix: Хүснэгт
fig-align: center
fig-env: "figure"
fig-height: 4
fig-width: 6
fig-pos: "!ht"
fig-format: pdf
fig-cap-location: top
tbl-cap-location: top
bibliography: references.bib
csl: ieee.csl
citeproc: true
link-citations: true
---

```{r Ерөнхий тохиргоо}
#| echo: false

options(xtable.comment = FALSE)
output_dir <- "_files"
if (!dir.exists(output_dir)) {
  dir.create(output_dir)
}
```

```{r global variables}
#| echo: false

conclusion <- NULL
```

# Өгөгдөл

UCI Machine Learning Repository-ийн German Credit dataset @uci_german_credit, @uci_ml_repo дээр суурилан borrower-level мэдээллээр зээлийн чанарыг үнэлэв. Энэ dataset нь 1000 зээлдэгч, good/bad кредит ангилал болон 20 гаруй шинж чанарыг (дансны төлөв, зээлийн хэмжээ, хугацаа, санхүүгийн индикаторууд) агуулдаг.

```{r download data}
if (file.exists("raw_data.Rds")) {
  raw_data <- readRDS(file = "raw_data.Rds")
} else {
  data_url <- "https://archive.ics.uci.edu/ml/machine-learning-databases/statlog/german/german.data"
  
  raw_data <- tryCatch({
    temp_file <- tempfile()
    download.file(data_url, temp_file, quiet = TRUE)
    
    col_names <- c(
      "checking_status", "duration", "credit_history", "purpose",
      "credit_amount", "savings_status", "employment", "installment_commitment",
      "personal_status", "other_parties", "residence_since", "property_magnitude",
      "age", "other_payment_plans", "housing", "existing_credits",
      "job", "num_dependents", "telephone", "foreign_worker", "class"
    )
    
    data_raw <- read.table(
      temp_file,
      sep = " ",
      stringsAsFactors = FALSE,
      col.names = col_names
    )
    
    unlink(temp_file)
    data_raw
  }, error = function(e) {
    warning("UCI-аас өгөгдөл татаж чадсангүй. Жишээ өгөгдөл ашиглаж байна.")
    set.seed(123)
    n <- 1000
    data.frame(
      checking_status = sample(c("A11", "A12", "A13", "A14"), n, replace = TRUE),
      duration = round(runif(n, 4, 72)),
      credit_amount = round(runif(n, 250, 18424)),
      age = round(runif(n, 19, 75)),
      class = sample(c(1, 2), n, replace = TRUE, prob = c(0.7, 0.3))
    )
  })
  
  saveRDS(raw_data, file = "raw_data.Rds")
  write.csv(raw_data, file = "raw_data.csv", row.names = FALSE)
}
```

Татаж авсан өгөгдлийг `raw_data.csv` файлд хадгалсан.

# Өгөгдөл бэлтгэх ба үндсэн статистик

```{r data preprocessing}
#| echo: false

set.seed(42)  # дахин давтагдах байдлыг хангах

cat_features <- c(
  "checking_status", "credit_history", "purpose", "savings_status",
  "employment", "personal_status", "other_parties", "property_magnitude",
  "other_payment_plans", "housing", "job", "telephone", "foreign_worker"
)
raw_data[cat_features] <- lapply(raw_data[cat_features], factor)

raw_data$class <- factor(raw_data$class, levels = c(1, 2), labels = c("good", "bad"))
raw_data$target_bad <- ifelse(raw_data$class == "bad", 1, 0)
```

```{r}
#| label: tbl-data
#| tbl-cap: German Credit dataset-ийн үндсэн статистик (borrower-level)

dataset_summary <- data.frame(
  "Үзүүлэлт" = c(
    "Нийт зээлдэгч",
    "Bad credit хувь (%)",
    "Good credit хувь (%)",
    "Дундаж зээлийн хэмжээ",
    "Дундаж зээлийн хугацаа (сар)",
    "Дундаж нас"
  ),
  "Утга" = c(
    nrow(raw_data),
    round(mean(raw_data$target_bad) * 100, 2),
    round(mean(raw_data$class == "good") * 100, 2),
    round(mean(raw_data$credit_amount), 0),
    round(mean(raw_data$duration), 1),
    round(mean(raw_data$age), 1)
  )
)

knitr::kable(dataset_summary, col.names = c("Үзүүлэлт", "Утга"))
```

# Судалгааны дизайн

- Зорилго: borrower-level мэдээллээр зээлдэгчийн bad credit магадлалыг логистик регрессээр үнэлэх.
- Train/test: 70/30 санамсаргүй хуваалт.
- Үнэлгээ: AUC, accuracy, precision, recall, confusion matrix; 0.5 босгоор high/low risk ангилна.

```{r}
#| echo: false

n <- nrow(raw_data)
train_idx <- sample(seq_len(n), size = floor(0.7 * n))
train_data <- raw_data[train_idx, ]
test_data  <- raw_data[-train_idx, ]
```

# Логистик регресс

```{r}
logit_formula <- target_bad ~ duration + credit_amount + age +
  checking_status + savings_status + employment + purpose + housing

model_logit <- glm(logit_formula, data = train_data, family = binomial(link = "logit"))
summary(model_logit)
```

```{r}
#| label: tbl-coef
#| tbl-cap: Логистик регрессийн коэффициентууд (bad credit логит)

coef_df <- coef(summary(model_logit))
coef_table <- data.frame(
  "Хувьсагч" = rownames(coef_df),
  "Коэффициент" = round(coef_df[, "Estimate"], 3),
  "Std. Error" = round(coef_df[, "Std. Error"], 3),
  "p-value" = signif(coef_df[, "Pr(>|z|)"], 3)
)
knitr::kable(coef_table, col.names = c("Хувьсагч", "Коэффициент", "Std. Error", "p-value"))
```

```{r}
conclusion <- append(conclusion,
  "Checking account статус, savings статус, зээлийн хэмжээ/хугацаа зэрэг нь логистик регрессээр bad credit магадлалд мэдэгдэхүйц хамааралтай гарлаа (p-value бага)."
)
```

# Үнэлгээ ба ангилал

```{r}
test_data$pred_prob <- predict(model_logit, newdata = test_data, type = "response")
threshold <- 0.5
test_data$pred_class <- ifelse(test_data$pred_prob >= threshold, "bad", "good")

cm <- table(Predicted = test_data$pred_class, Actual = test_data$class)
get_cm <- function(r, c) ifelse(r %in% rownames(cm) && c %in% colnames(cm), cm[r, c], 0)

accuracy <- mean(test_data$pred_class == test_data$class)
precision_bad <- get_cm("bad", "bad") / max(1, sum(cm["bad", ]))
recall_bad <- get_cm("bad", "bad") / max(1, sum(cm[, "bad"]))
```

```{r}
#| label: tbl-confusion
#| tbl-cap: Confusion matrix (test, threshold = 0.5)

knitr::kable(as.data.frame.matrix(cm), col.names = colnames(cm), row.names = TRUE)
```

```{r}
roc_data <- test_data[order(test_data$pred_prob, decreasing = TRUE), c("pred_prob", "target_bad")]
tp <- cumsum(roc_data$target_bad)
fp <- cumsum(1 - roc_data$target_bad)
tpr <- c(0, tp / max(1, sum(roc_data$target_bad)), 1)
fpr <- c(0, fp / max(1, sum(1 - roc_data$target_bad)), 1)
auc_val <- sum(diff(fpr) * (head(tpr, -1) + tail(tpr, -1)) / 2)
```

```{r create roc plot}
#| results: hide

Cairo::CairoPDF(
  file = file.path(output_dir, "fig-roc.pdf"),
  family = "Times New Roman", width = 5, height = 5
)

plot(
  fpr, tpr, type = "l", lwd = 2,
  xlab = "False Positive Rate", ylab = "True Positive Rate",
  main = "ROC муруй (test)"
)
abline(a = 0, b = 1, lty = 2, col = "gray50")
text(0.6, 0.2, labels = paste0("AUC = ", round(auc_val, 3)))

dev.off()
```

```{r}
#| label: fig-roc
#| fig-cap: ROC муруй ба AUC (test багц)

knitr::include_graphics(file.path(output_dir, "fig-roc.pdf"))
```

```{r}
conclusion <- append(conclusion, sprintf(
  "Test accuracy = %.3f, precision(bad) = %.3f, recall(bad) = %.3f, AUC = %.3f (threshold = %.2f).",
  accuracy, precision_bad, recall_bad, auc_val, threshold
))

high_risk_share <- mean(test_data$pred_class == "bad") * 100
conclusion <- append(conclusion, sprintf(
  "Test багц дээр %.1f%% зээлдэгчийг high-risk (bad) гэж ангилсан; эдгээрийг нэмэлт баталгаажуулалт эсвэл баталгааны нэмэлт шаардлагад оруулах боломжтой.",
  high_risk_share
))
```

# Дүгнэлт {.unnumbered}

```{r}
#| results: asis

for (i in seq_along(conclusion)) {
  cat(paste0(i, ". ", conclusion[i], "\n"))
}; rm(i)
```

# Ашигласан материал {.unnumbered}

::: {#refs}
:::
