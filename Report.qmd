---
title: "Зээлийн эрсдэлийг статистик загварчлалаар үнэлэх"
subtitle: ""
abstract: German Credit dataset дээр borrower-level мэдээлэл ашиглан зээлийн чанарыг (good/bad) логистик регрессээр үнэлж, эрсдэлийн ангилал, AUC ба гол драйверуудыг тооцсон үр дүн.
author: ""
date: 2025-11-20
date-format: "YYYY оны M-р сарын D"
project:
  execute-dir: project
  preview: false
toc: true
toc-depth: 3
toc-title: Агуулга
number-sections: true
format:
  pdf:
    echo: true
    pdf-engine: pdflatex
    papersize: a4paper
    geometry:
      - left=2cm
      - right=2cm
      - top=2cm
      - bottom=3cm
    include-in-header:
      - text: |
          \usepackage[english,mongolian]{babel}
          \usepackage[T1]{fontenc}
          \usepackage[utf8]{inputenc}
          \usepackage{lmodern}
          \usepackage{inconsolata}
          \usepackage{amsmath,amssymb}
          \AddToHook{env/Highlighting/begin}{\footnotesize}
          % үндсэн гарчиг
          \usepackage{titling}
          \pretitle{\begin{center}\LARGE\bfseries}
          \posttitle{\par\end{center}\vskip 1em}
          % сэдвийн зүйлчлэл хэсгийн шрифт
          \usepackage{titlesec}
          \titleformat{\section}{\normalfont\Large\bfseries\selectfont}{\thesection}{1em}{}
          \titleformat{\subsection}{\normalfont\large\bfseries\selectfont}{\thesubsection}{1em}{}
          \titleformat{\subsubsection}{\normalfont\normalsize\bfseries\selectfont}{\thesubsubsection}{1em}{}
          % сэдвийн жагсаалт доторх шрифт
          \usepackage{tocloft}
          \renewcommand{\cfttoctitlefont}{\Large\bfseries}
          \renewcommand{\cftaftertoctitle}{\vskip 1em}
          \renewcommand{\cftsecfont}{\normalfont\selectfont}
          \renewcommand{\cftsecpagefont}{\normalfont\selectfont}
          \renewcommand{\cftsubsecfont}{\normalfont\selectfont}
          \renewcommand{\cftsubsecpagefont}{\normalfont\selectfont}
          \renewcommand{\contentsname}{Агуулга}
    latex-max-runs: 3
editor: source
execute:
  echo: false
  warning: false
crossref: 
  fig-title: Зураг
  fig-prefix: Зураг
  tbl-title: Хүснэгт
  tbl-prefix: Хүснэгт
fig-align: center
fig-env: "figure"
fig-height: 4
fig-width: 6
fig-pos: "!ht"
fig-format: pdf
fig-cap-location: top
tbl-cap-location: top
bibliography: references.bib
csl: ieee.csl
citeproc: true
link-citations: true
---

```{r setup}
#| echo: false

options(xtable.comment = FALSE)
output_dir <- "_files"
if (!dir.exists(output_dir)) dir.create(output_dir)
```

```{r packages}
#| echo: false

pkgs <- c("Cairo", "knitr", "glmnet")
missing <- pkgs[!vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)]
if (length(missing)) {
  stop("Дараах багцууд дутуу: ", paste(missing, collapse = ", "))
}
suppressPackageStartupMessages({
  library(Cairo)
  library(glmnet)
})
```

```{r helpers}
#| echo: false

conclusion <- NULL
set.seed(42)  # дахин давтагдах байдлыг хангах

roc_points <- function(prob, y) {
  ord <- order(prob, decreasing = TRUE)
  tp <- cumsum(y[ord]); fp <- cumsum(1 - y[ord])
  tpr <- c(0, tp / max(1, sum(y)), 1)
  fpr <- c(0, fp / max(1, sum(1 - y)), 1)
  list(fpr = fpr, tpr = tpr)
}

auc_manual <- function(prob, y) {
  rp <- roc_points(prob, y)
  sum(diff(rp$fpr) * (head(rp$tpr, -1) + tail(rp$tpr, -1)) / 2)
}

pr_curve <- function(prob, y) {
  ord <- order(prob, decreasing = TRUE)
  yord <- y[ord]
  tp <- cumsum(yord); fp <- cumsum(1 - yord)
  precision <- tp / pmax(1, tp + fp)
  recall <- tp / max(1, sum(y))
  data.frame(recall = recall, precision = precision)
}
```

# Өгөгдөл

UCI Machine Learning Repository-ийн German Credit dataset @uci_german_credit, @uci_ml_repo дээр суурилан borrower-level мэдээллээр зээлийн чанарыг үнэлэв. Энэ dataset нь 1000 зээлдэгч, good/bad кредит ангилал болон 20+ шинж чанарыг (дансны төлөв, зээлийн хэмжээ, хугацаа, орлогын индикаторууд) агуулдаг.

```{r download-data}
if (file.exists("raw_data.Rds")) {
  raw_data <- readRDS(file = "raw_data.Rds")
} else {
  data_url <- "https://archive.ics.uci.edu/ml/machine-learning-databases/statlog/german/german.data"
  
  raw_data <- tryCatch({
    tmp <- tempfile()
    download.file(data_url, tmp, quiet = TRUE)
    col_names <- c(
      "checking_status", "duration", "credit_history", "purpose",
      "credit_amount", "savings_status", "employment", "installment_commitment",
      "personal_status", "other_parties", "residence_since", "property_magnitude",
      "age", "other_payment_plans", "housing", "existing_credits",
      "job", "num_dependents", "telephone", "foreign_worker", "class"
    )
    data_raw <- read.table(tmp, sep = " ", stringsAsFactors = FALSE, col.names = col_names)
    unlink(tmp)
    data_raw
  }, error = function(e) {
    warning("UCI-аас өгөгдөл татаж чадсангүй. Жишээ өгөгдөл ашиглаж байна.")
    n <- 1000
    data.frame(
      checking_status = sample(c("A11", "A12", "A13", "A14"), n, replace = TRUE),
      duration = round(runif(n, 4, 72)),
      credit_amount = round(runif(n, 250, 18424)),
      age = round(runif(n, 19, 75)),
      class = sample(c(1, 2), n, replace = TRUE, prob = c(0.7, 0.3))
    )
  })
  
  saveRDS(raw_data, file = "raw_data.Rds")
  write.csv(raw_data, file = "raw_data.csv", row.names = FALSE)
}
```

# Өгөгдөл бэлтгэх ба үндсэн статистик

```{r data-prep}
#| echo: false

cat_features <- c(
  "checking_status", "credit_history", "purpose", "savings_status",
  "employment", "personal_status", "other_parties", "property_magnitude",
  "other_payment_plans", "housing", "job", "telephone", "foreign_worker"
)
raw_data[cat_features] <- lapply(raw_data[cat_features], factor)

raw_data$class <- factor(raw_data$class, levels = c(1, 2), labels = c("good", "bad"))
raw_data$target_bad <- ifelse(raw_data$class == "bad", 1, 0)
```

```{r}
#| label: tbl-data
#| tbl-cap: German Credit dataset-ийн үндсэн статистик (borrower-level)

dataset_summary <- data.frame(
  "Үзүүлэлт" = c(
    "Нийт зээлдэгч",
    "Bad credit хувь (%)",
    "Good credit хувь (%)",
    "Дундаж зээлийн хэмжээ",
    "Дундаж зээлийн хугацаа (сар)",
    "Дундаж нас"
  ),
  "Утга" = c(
    nrow(raw_data),
    round(mean(raw_data$target_bad) * 100, 2),
    round(mean(raw_data$class == "good") * 100, 2),
    round(mean(raw_data$credit_amount), 0),
    round(mean(raw_data$duration), 1),
    round(mean(raw_data$age), 1)
  )
)

knitr::kable(dataset_summary, col.names = c("Үзүүлэлт", "Утга"))
```

# Судалгааны дизайн

- Зорилго: borrower-level мэдээллээр зээлдэгчийн bad credit магадлалыг логистик регрессээр тооцох.
- Train/test: 70/30 санамсаргүй хуваалт.
- Үнэлгээ: AUC, accuracy, precision, recall, confusion matrix; 0.5 босгоор high/low risk ангилна.

```{r split}
#| echo: false

n <- nrow(raw_data)
train_idx <- sample(seq_len(n), size = floor(0.7 * n))
train_data <- raw_data[train_idx, ]
test_data  <- raw_data[-train_idx, ]
```

# Логистик регресс

```{r model}
logit_formula <- target_bad ~ duration + credit_amount + age +
  checking_status + savings_status + employment + purpose + housing

model_logit <- glm(logit_formula, data = train_data, family = binomial(link = "logit"))
summary(model_logit)
```

```{r}
#| label: tbl-coef
#| tbl-cap: Логистик регрессийн коэффициентууд (bad credit логит)

coef_df <- coef(summary(model_logit))
coef_table <- data.frame(
  "Хувьсагч" = rownames(coef_df),
  "Коэффициент" = round(coef_df[, "Estimate"], 3),
  "Std. Error" = round(coef_df[, "Std. Error"], 3),
  "p-value" = signif(coef_df[, "Pr(>|z|)"], 3)
)
knitr::kable(coef_table, col.names = c("Хувьсагч", "Коэффициент", "Std. Error", "p-value"))
```

```{r}
conclusion <- append(conclusion,
  "Checking account статус, savings статус, зээлийн хэмжээ/хугацаа зэрэг нь логистик регрессээр bad credit магадлалд мэдэгдэхүйц хамааралтай гарлаа (p-value бага)."
)
```

# Үнэлгээ ба ангилал

```{r}
test_data$pred_prob <- predict(model_logit, newdata = test_data, type = "response")
threshold <- 0.5
test_data$pred_class <- ifelse(test_data$pred_prob >= threshold, "bad", "good")

cm <- table(Predicted = test_data$pred_class, Actual = test_data$class)
get_cm <- function(r, c) ifelse(r %in% rownames(cm) && c %in% colnames(cm), cm[r, c], 0)

accuracy <- mean(test_data$pred_class == test_data$class)
precision_bad <- get_cm("bad", "bad") / max(1, sum(cm["bad", ]))
recall_bad <- get_cm("bad", "bad") / max(1, sum(cm[, "bad"]))
```

```{r}
#| label: tbl-confusion
#| tbl-cap: Confusion matrix (test, threshold = 0.5)

knitr::kable(as.data.frame.matrix(cm), col.names = colnames(cm), row.names = TRUE)
```

```{r}
rp_logit <- roc_points(test_data$pred_prob, test_data$target_bad)
auc_val <- auc_manual(test_data$pred_prob, test_data$target_bad)
```

```{r roc-plot}
#| results: hide

Cairo::CairoPDF(
  file = file.path(output_dir, "fig-roc.pdf"),
  family = "Times New Roman", width = 5, height = 5
)

plot(
  rp_logit$fpr, rp_logit$tpr, type = "l", lwd = 2,
  xlab = "False Positive Rate", ylab = "True Positive Rate",
  main = "ROC муруй (test)"
)
abline(a = 0, b = 1, lty = 2, col = "gray50")
text(0.6, 0.2, labels = paste0("AUC = ", round(auc_val, 3)))

dev.off()
```

```{r}
#| label: fig-roc
#| fig-cap: ROC муруй ба AUC (test багц)

knitr::include_graphics(file.path(output_dir, "fig-roc.pdf"))
```

```{r}
conclusion <- append(conclusion, sprintf(
  "Test accuracy = %.3f, precision(bad) = %.3f, recall(bad) = %.3f, AUC = %.3f (threshold = %.2f).",
  accuracy, precision_bad, recall_bad, auc_val, threshold
))

high_risk_share <- mean(test_data$pred_class == "bad") * 100
conclusion <- append(conclusion, sprintf(
  "Test багц дээр %.1f%% зээлдэгчийг high-risk (bad) гэж ангилсан; эдгээрийг нэмэлт баталгаажуулалт эсвэл баталгааны нэмэлт шаардлагад оруулах боломжтой.",
  high_risk_share
))
```

# Пеналти логистик (glmnet)

```{r}
x_train <- model.matrix(logit_formula, data = train_data)[, -1]
x_test  <- model.matrix(logit_formula, data = test_data)[, -1]

cv_fit <- glmnet::cv.glmnet(
  x_train, train_data$target_bad,
  family = "binomial", alpha = 0.5, nfolds = 5, type.measure = "auc"
)
lambda_opt <- cv_fit$lambda.1se
cv_auc_opt <- cv_fit$cvm[cv_fit$lambda == lambda_opt]

test_data$pred_prob_glmnet <- as.numeric(predict(cv_fit, newx = x_test, s = lambda_opt, type = "response"))
auc_glmnet <- auc_manual(test_data$pred_prob_glmnet, test_data$target_bad)
brier_glmnet <- mean((test_data$pred_prob_glmnet - test_data$target_bad) ^ 2)
```

```{r pr-curve}
#| results: hide

pr_glmnet <- pr_curve(test_data$pred_prob_glmnet, test_data$target_bad)

Cairo::CairoPDF(
  file = file.path(output_dir, "fig-pr-glmnet.pdf"),
  family = "Times New Roman", width = 5, height = 5
)

plot(
  pr_glmnet$recall, pr_glmnet$precision, type = "l", lwd = 2,
  xlab = "Recall", ylab = "Precision",
  main = "Precision-Recall (glmnet)"
)

dev.off()
```

```{r}
#| label: fig-pr-glmnet
#| fig-cap: Penalized логистик (glmnet) – Precision-Recall муруй (test)

knitr::include_graphics(file.path(output_dir, "fig-pr-glmnet.pdf"))
```

```{r}
conclusion <- append(conclusion, sprintf(
  "Пеналти логистик (glmnet, alpha=0.5) CV AUC = %.3f (lambda.1se), test AUC = %.3f, Brier = %.3f.",
  cv_auc_opt, auc_glmnet, brier_glmnet
))
```

# Дүгнэлт {.unnumbered}

```{r}
#| results: asis

for (i in seq_along(conclusion)) {
  cat(paste0(i, ". ", conclusion[i], "\n"))
}; rm(i)
```

# Ажиллуулах заавар {.unnumbered}

- Урьдчилсан: R 4.x, Quarto; R-д `install.packages(c("Cairo","knitr","glmnet"))`.
- Төслийн хавтас руу орон: `quarto render Report.qmd` (YAML-д pdflatex заасан).
- Үр дүн: `Report.pdf`, `_files/fig-roc.pdf`, мөн `raw_data.Rds`/`raw_data.csv` автоматаар бий болно.

# Багийн гишүүд ба үүрэг {.unnumbered}

| Гишүүн | Үүрэг/оролцоо |
|--------|---------------|
| Анхтулга Ган. (21B1NUM3098) |  |
| Билгүүн Энх. (23B1NUM0577) |  |
| Мөнхбаяр Бям. (21B1NUM0437) |  |
| Нарансолонго Буя. (23B1NUM2631) |  |
| Номин-Эрдэнэ Пүр. (22B1NUM7118) |  |

# Ашигласан материал {.unnumbered}

::: {#refs}
:::
